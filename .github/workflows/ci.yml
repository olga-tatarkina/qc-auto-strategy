name: CI/CD for QC-Auto

on:
  push:
    branches:
      - main

jobs:

  lint-and-format:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install formatting & linting tools
        run: |
          python -m pip install --upgrade pip setuptools
          pip install black flake8 lean
      - name: Format code
        run: black QC-Auto/main.py
      - name: Lint code
        run: flake8 QC-Auto/main.py

  cloud-backtest:
    needs: lint-and-format
    runs-on: ubuntu-latest
    env:
      QC_USER_ID: ${{ secrets.QC_USER_ID }}
      QC_API_TOKEN: ${{ secrets.QC_API_TOKEN }}
      TELEGRAM_WEBHOOK: ${{ secrets.TELEGRAM_WEBHOOK }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python & Lean
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install Lean CLI
        run: pip install lean

      - name: Login to QuantConnect
        run: lean login --user-id $QC_USER_ID --api-token $QC_API_TOKEN
        shell: bash

      - name: Run cloud backtest and notify Telegram
        shell: bash
        run: |
          echo "üîÑ Starting cloud backtest..."
          # –ó–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫—Ç–µ—Å—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å –≤—ã–≤–æ–¥
          OUTPUT=$(lean cloud backtest --push --name "CI Backtest" "./QC-Auto")
          echo "$OUTPUT"

          # –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º URL –∏–∑ –≤—ã–≤–æ–¥–∞
          URL=$(echo "$OUTPUT" | grep -Eo 'https://www\.quantconnect\.com/project/[0-9]+/[0-9a-f]+')
          echo "üîó Backtest URL: $URL"

          # –®–ª—ë–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
          curl -X POST "$TELEGRAM_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{\"text\": \"‚úÖ Backtest –∑–∞–≤–µ—Ä—à—ë–Ω. –°—Å—ã–ª–∫–∞: $URL\"}"
